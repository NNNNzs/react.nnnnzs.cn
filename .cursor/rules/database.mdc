---
description: "数据库开发规范 - Prisma ORM 和 MySQL"
alwaysApply: false
---
# 数据库开发规范

## 数据库技术栈

### 核心技术
- **ORM**: Prisma 6.2.1
- **数据库**: MySQL 5.7+
- **迁移工具**: Prisma db push（同步数据库结构）

### 数据库连接配置
```bash
DATABASE_URL="mysql://user:password@host:port/database"
```

## 数据模型定义

### Prisma Schema 位置
- **文件**: `prisma/schema.prisma`
- **备份**: `src/generated/prisma-client/schema.prisma`

### 实体命名规范
- **表名**: `tb_` 前缀 + 小写 + 下划线（如：`tb_post`, `tb_user`）
- **字段名**: 小写 + 下划线（如：`created_at`, `user_id`）
- **主键**: `id` (BigInt, Auto Increment)
- **软删除**: `is_delete` (Int, 0=正常, 1=删除)
- **时间戳**:
  - `created_at` (DateTime, @default(now()))
  - `updated_at` (DateTime, @updatedAt)

### 基础实体模板
```prisma
// 示例：文章表
model TbPost {
  id         Int       @id @default(autoincrement())
  path       String    @db.VarChar(255)
  title      String?   @db.VarChar(255)
  category   String?   @db.VarChar(255)
  tags       String?   @db.VarChar(255)  // 存储为逗号分隔的字符串
  date       DateTime? @db.DateTime(0)
  updated    DateTime? @db.DateTime(0)
  cover      String?   @db.VarChar(255)
  layout     String?   @db.VarChar(255)
  content    String    @db.Text
  description String?  @db.VarChar(500)
  visitors   Int?      @default(0)
  likes      Int?      @default(0)
  hide       String?   @default("0") @db.VarChar(255)
  is_delete  Int       @default(0)
  created_by  Int?     // 创建人ID

  // 关联关系
  creator            TbUser?            @relation(fields: [created_by], references: [id])
  versions           TbPostVersion[]
  collectionPosts    TbCollectionPost[]
  comments           TbComment[]

  @@index([is_delete])
  @@index([category, hide])
  @@map("tb_post")
}

// 示例：用户表
model TbUser {
  id              Int       @id @default(autoincrement())
  role            String?   @db.VarChar(255)
  account         String    @db.VarChar(16)
  avatar          String?   @db.VarChar(255)
  password        String    @db.VarChar(255)
  nickname        String    @db.VarChar(16)
  mail            String?   @db.VarChar(30)
  github_id       String?   @db.VarChar(255)
  github_username String?   @db.VarChar(255)
  status          Int       @default(1)

  // 关联关系
  posts             TbPost[]
  collections       TbCollection[]
  comments          TbComment[]
  createdChangeLogs TbEntityChangeLog[] @relation("EntityChangeLogCreator")

  @@unique([account])
  @@map("tb_user")
}

// 示例：评论表（支持回复）
model TbComment {
  id         Int       @id @default(autoincrement())
  post_id    Int       // 关联文章ID
  user_id    Int       // 评论者用户ID
  parent_id  Int?      // 父评论ID（用于回复），null 表示顶级评论
  content    String    @db.Text
  status     Int       @default(1)  // 0=隐藏, 1=显示
  is_delete  Int       @default(0)
  like_count Int       @default(0)
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt

  // 关联关系
  post    TbPost     @relation("PostComments", fields: [post_id], references: [id])
  user    TbUser     @relation("UserComments", fields: [user_id], references: [id])
  parent  TbComment? @relation("CommentReplies", fields: [parent_id], references: [id])
  replies TbComment[] @relation("CommentReplies")

  @@index([post_id, is_delete])
  @@index([user_id, is_delete])
  @@index([parent_id])
  @@index([created_at])
  @@map("tb_comment")
}

// 示例：实体变更日志表
model TbEntityChangeLog {
  id          Int      @id @default(autoincrement())
  entity_id   Int      // 实体ID（文章ID、合集ID等）
  entity_type String   @db.VarChar(50)  // POST, COLLECTION, CATEGORY, TAG 等
  field_name  String   @db.VarChar(100)
  old_value   String?  @db.Text
  new_value   String?  @db.Text
  value_type  String   @db.VarChar(20)  // string, number, boolean, array, object
  created_at  DateTime @default(now())
  created_by  Int?     // 操作人ID（可能为null，如系统操作）

  creator TbUser? @relation("EntityChangeLogCreator", fields: [created_by], references: [id])

  @@index([entity_id, entity_type])
  @@index([entity_type, created_at])
  @@index([created_by, created_at])
  @@map("tb_entity_change_log")
}
```

## 数据库迁移规范

### 重要原则
**✅ 本项目使用 Prisma db push 同步数据库结构**

### 迁移开发流程

#### 1. 修改 Schema
```bash
# 1. 修改 prisma/schema.prisma
vim prisma/schema.prisma

# 2. 同步数据库结构（开发环境）
pnpm prisma db push

# 3. 生成 Prisma Client
pnpm prisma generate
```

#### 2. 开发环境工作流
```bash
# 完整的开发流程
# 1. 修改 Schema
vim prisma/schema.prisma

# 2. 推送数据库变更（会自动创建/修改表结构）
pnpm prisma db push

# 3. 生成 Client（如果 Schema 有变更）
pnpm prisma generate

# 4. 更新代码
vim src/services/xxx.ts
```

#### 3. 生产环境部署
```bash
# 1. 备份数据库（重要！）
mysqldump -u root -p production_db > backup_$(date +%Y%m%d_%H%M%S).sql

# 2. 推送数据库变更
pnpm prisma db push

# 3. 生成 Client
pnpm prisma generate

# 4. 重启应用
pm2 restart ecosystem.config.cjs
```

### Prisma db push 说明

#### 功能
- 将 Prisma Schema 中的变更直接同步到数据库
- 自动创建新表、添加字段、创建索引等
- 适用于快速开发和原型设计

#### 注意事项
- ⚠️ **生产环境使用前务必备份数据库**
- ⚠️ 某些复杂变更（如删除字段）可能需要手动处理
- ⚠️ 不会保留迁移历史，适合小团队或快速迭代项目

#### 常用选项
```bash
# 基本推送
pnpm prisma db push

# 跳过生成 Client（如果只需要同步结构）
pnpm prisma db push --skip-generate

# 接受数据丢失风险（谨慎使用）
pnpm prisma db push --accept-data-loss
```

## 数据库操作规范

### 查询操作

#### 基础查询
```typescript
// src/services/user.ts
import { getPrisma } from '@/lib/prisma'

/**
 * 获取用户信息
 */
export async function getUserById(id: bigint) {
  const prisma = await getPrisma()

  return await prisma.tbUser.findUnique({
    where: { id, is_delete: 0 },
    select: {
      id: true,
      username: true,
      nickname: true,
      avatar: true,
      email: true,
      role: true,
      // 不返回 password
    },
  })
}
```

#### 分页查询
```typescript
/**
 * 分页获取文章列表
 */
export async function getPostList(params: {
  pageNum?: number
  pageSize?: number
  hide?: string
}) {
  const { pageNum = 1, pageSize = 10, hide = '0' } = params
  const prisma = await getPrisma()

  const where = {
    is_delete: 0,
    ...(hide !== 'all' && { hide }),
  }

  const [record, total] = await Promise.all([
    prisma.tbPost.findMany({
      where,
      orderBy: { date: 'desc' },
      take: pageSize,
      skip: (pageNum - 1) * pageSize,
    }),
    prisma.tbPost.count({ where }),
  ])

  return { record, total, pageNum, pageSize }
}
```

### 插入操作

```typescript
/**
 * 创建用户
 */
export async function createUser(data: {
  username: string
  password: string
  nickname?: string
}) {
  const prisma = await getPrisma()

  // 检查用户名是否存在
  const existing = await prisma.tbUser.findUnique({
    where: { username: data.username },
  })

  if (existing) {
    throw new Error('用户名已存在')
  }

  return await prisma.tbUser.create({
    data: {
      username: data.username,
      password: data.password, // 已加密
      nickname: data.nickname || data.username,
      role: 'user',
    },
  })
}
```

### 更新操作

```typescript
/**
 * 软删除文章
 */
export async function deletePost(id: bigint) {
  const prisma = await getPrisma()

  return await prisma.tbPost.update({
    where: { id },
    data: {
      is_delete: 1,
      updated_at: new Date(),
    },
  })
}
```

### 事务操作

```typescript
/**
 * 创建文章并更新统计
 */
export async function createPostWithStats(data: {
  title: string
  content: string
  userId: bigint
}) {
  const prisma = await getPrisma()

  return await prisma.$transaction(async (tx) => {
    // 1. 创建文章
    const post = await tx.tbPost.create({
      data: {
        title: data.title,
        content: data.content,
        user_id: data.userId,
      },
    })

    // 2. 更新用户统计
    await tx.tbUser.update({
      where: { id: data.userId },
      data: {
        post_count: {
          increment: 1,
        },
      },
    })

    return post
  })
}
```

## 性能优化

### 索引策略
在 Prisma Schema 中定义索引：
```prisma
model TbPost {
  // ... 字段定义

  @@index([is_delete])
  @@index([category, hide])
  @@index([date])
  @@map("tb_post")
}
```

### 避免全表扫描
```typescript
// ❌ 不好的做法 - 全表模糊查询
const posts = await prisma.tbPost.findMany({
  where: {
    OR: [
      { title: { contains: keyword } },
      { content: { contains: keyword } },
    ],
  },
})

// ✅ 好的做法 - 限制查询范围
const posts = await prisma.tbPost.findMany({
  where: {
    is_delete: 0,
    hide: '0',
    OR: [
      { title: { contains: keyword } },
      { content: { contains: keyword } },
    ],
  },
  take: 20, // 限制结果数量
  orderBy: { date: 'desc' },
})
```

### 批量操作优化
```typescript
// ❌ N+1 问题
for (const id of userIds) {
  await prisma.tbUser.findUnique({ where: { id } })
}

// ✅ 批量查询
await prisma.tbUser.findMany({
  where: { id: { in: userIds } }
})
```

## 安全规范

### 防止 SQL 注入
- ✅ 使用 Prisma（自动防护）
- ❌ 不要拼接 SQL 字符串

### 敏感字段保护
```typescript
// ✅ 不返回敏感字段
const user = await prisma.tbUser.findUnique({
  where: { id },
  select: {
    id: true,
    username: true,
    nickname: true,
    avatar: true,
    // 不返回：password, token 等
  },
})
```

## 常用命令

```bash
# 生成 Prisma Client
pnpm prisma generate

# 查看数据库（GUI）
pnpm prisma studio

# 同步数据库结构（开发环境）
pnpm prisma db push

# 从数据库同步 Schema（反向工程）
pnpm prisma db pull

# 验证 Schema 语法
pnpm prisma validate

# 格式化 Schema
pnpm prisma format
```

## 工作流程

### 1. 新功能开发
```bash
# 1. 修改 Schema
vim prisma/schema.prisma

# 2. 同步数据库结构
pnpm prisma db push

# 3. 生成 Client
pnpm prisma generate

# 4. 更新代码
vim src/services/xxx.ts
```

### 2. 生产部署
```bash
# 1. 备份数据库（必须！）
mysqldump -u root -p prod_db > backup_$(date +%Y%m%d_%H%M%S).sql

# 2. 同步数据库结构
pnpm prisma db push

# 3. 生成 Client
pnpm prisma generate

# 4. 重启应用
pm2 restart ecosystem.config.cjs
```

### 3. 从现有数据库生成 Schema
```bash
# 如果数据库已存在，可以从数据库反向生成 Schema
pnpm prisma db pull

# 然后生成 Client
pnpm prisma generate
```

## 核心原则

1. ✅ **使用 Prisma db push** 同步数据库结构
2. ✅ **修改 Schema 后立即同步** 避免结构不一致
3. ✅ **生产环境部署前备份数据库** 防止数据丢失
4. ✅ **使用索引** 优化查询性能
5. ✅ **软删除** 保护数据安全
6. ✅ **敏感字段** 不返回给前端
