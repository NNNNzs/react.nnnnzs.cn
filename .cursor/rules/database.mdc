---
description: "数据库开发规范 - Prisma ORM 和 MySQL"
globs: ["prisma/**/*.prisma", "docs/migrations/**/*.sql", "src/services/**/*.ts"]
alwaysApply: false
---

# 数据库开发规范

## 数据库技术栈

### 核心技术
- **ORM**: Prisma 6.2.1
- **数据库**: MySQL 5.7+
- **迁移工具**: 自定义 SQL 脚本（**不使用 Prisma Migrate**）

### 数据库连接配置
```bash
DATABASE_URL="mysql://user:password@host:port/database"
```

## 数据模型定义

### Prisma Schema 位置
- **文件**: `prisma/schema.prisma`
- **备份**: `src/generated/prisma-client/schema.prisma`

### 实体命名规范
- **表名**: `tb_` 前缀 + 小写 + 下划线（如：`tb_post`, `tb_user`）
- **字段名**: 小写 + 下划线（如：`created_at`, `user_id`）
- **主键**: `id` (BigInt, Auto Increment)
- **软删除**: `is_delete` (Int, 0=正常, 1=删除)
- **时间戳**:
  - `created_at` (DateTime, @default(now()))
  - `updated_at` (DateTime, @updatedAt)

### 基础实体模板
```prisma
// 示例：文章表
model TbPost {
  id         BigInt    @id @default(autoincrement())
  title      String?
  content    String?   @db.Text
  category   String?
  tags       String?   // 存储为逗号分隔的字符串
  date       DateTime?
  hide       String    @default("0")
  visitors   Int       @default(0)
  likes      Int       @default(0)
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
  is_delete  Int       @default(0)

  @@index([is_delete])
  @@index([category, hide])
  @@map("tb_post")
}

// 示例：用户表
model TbUser {
  id         BigInt    @id @default(autoincrement())
  username   String    @unique
  password   String
  nickname   String?
  avatar     String?
  email      String?
  role       String    @default("user")  // user, admin
  github_id  String?   @unique
  wechat_id  String?   @unique
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
  is_delete  Int       @default(0)

  @@index([is_delete])
  @@map("tb_user")
}
```

## 数据库迁移规范

### 重要原则
**⚠️ 本项目不使用 Prisma Migrate，必须手写 SQL 迁移脚本**

### 迁移文件管理

#### 迁移文件位置
```
docs/migrations/
├── 20251218_001_create_tables.sql          # 初始建表
├── 20251218_002_add_user_fields.sql        # 添加字段
├── 20251218_003_create_indexes.sql         # 创建索引
└── README.md                                # 迁移说明
```

#### 迁移文件命名规范
```
YYYYMMDD_序号_描述.sql
```

示例：
- `20251218_001_initial_schema.sql`
- `20251218_002_add_post_tags.sql`
- `20251218_003_create_user_indexes.sql`

### 迁移开发流程

#### 1. 修改 Schema
```bash
# 1. 修改 prisma/schema.prisma
# 2. 重新生成 Prisma Client
pnpm prisma generate
```

#### 2. 迁移脚本模板
```sql
-- docs/migrations/20251218_001_add_user_fields.sql

-- 说明：添加用户表的手机号字段
-- 作者：[你的名字]
-- 日期：2025-12-18
-- 影响表：tb_user

-- 开始事务
START TRANSACTION;

-- 检查字段是否存在
SELECT COUNT(*) INTO @column_exists
FROM information_schema.columns
WHERE table_schema = DATABASE()
  AND table_name = 'tb_user'
  AND column_name = 'phone';

-- 如果字段不存在，则添加
SET @sql = IF(@column_exists = 0,
  'ALTER TABLE tb_user ADD COLUMN phone VARCHAR(20) NULL AFTER email',
  'SELECT "字段已存在，跳过" AS result');

PREPARE stmt FROM @sql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;

-- 提交事务
COMMIT;
```

#### 3. 安全的字段添加
```sql
-- 1. 检查字段是否存在
SELECT COUNT(*) as count
FROM information_schema.columns
WHERE table_schema = DATABASE()
  AND table_name = 'tb_user'
  AND column_name = 'new_field';

-- 2. 添加字段
ALTER TABLE tb_user
ADD COLUMN new_field VARCHAR(255) NULL DEFAULT NULL;

-- 3. 添加索引（可选）
ALTER TABLE tb_user
ADD INDEX idx_new_field (new_field);

-- 4. 更新现有数据（可选）
UPDATE tb_user
SET new_field = 'default_value'
WHERE new_field IS NULL;
```

#### 4. 索引管理
```sql
-- 创建索引
ALTER TABLE tb_post
ADD INDEX idx_category (category),
ADD INDEX idx_date (date);

-- 创建唯一索引
ALTER TABLE tb_user
ADD UNIQUE INDEX uk_username (username);

-- 创建复合索引
ALTER TABLE tb_comment
ADD INDEX idx_post_user (post_id, user_id);

-- 删除索引
ALTER TABLE tb_post
DROP INDEX idx_category;
```

### 迁移执行流程

#### 开发环境
```bash
# 1. 查看待执行的迁移
ls -la docs/migrations/

# 2. 执行迁移（手动）
mysql -u root -p database_name < docs/migrations/20251218_001_add_fields.sql

# 3. 验证迁移
pnpm prisma db pull  # 查看当前数据库状态
```

#### 生产环境
```bash
# 1. 备份数据库
mysqldump -u root -p production_db > backup_20251218.sql

# 2. 执行迁移
mysql -u root -p production_db < docs/migrations/20251218_001_add_fields.sql

# 3. 验证
# - 检查应用日志
# - 测试相关功能
# - 回滚方案准备
```

## 数据库操作规范

### 查询操作

#### 基础查询
```typescript
// src/services/user.ts
import { getPrisma } from '@/lib/prisma'

/**
 * 获取用户信息
 */
export async function getUserById(id: bigint) {
  const prisma = await getPrisma()

  return await prisma.tbUser.findUnique({
    where: { id, is_delete: 0 },
    select: {
      id: true,
      username: true,
      nickname: true,
      avatar: true,
      email: true,
      role: true,
      // 不返回 password
    },
  })
}
```

#### 分页查询
```typescript
/**
 * 分页获取文章列表
 */
export async function getPostList(params: {
  pageNum?: number
  pageSize?: number
  hide?: string
}) {
  const { pageNum = 1, pageSize = 10, hide = '0' } = params
  const prisma = await getPrisma()

  const where = {
    is_delete: 0,
    ...(hide !== 'all' && { hide }),
  }

  const [record, total] = await Promise.all([
    prisma.tbPost.findMany({
      where,
      orderBy: { date: 'desc' },
      take: pageSize,
      skip: (pageNum - 1) * pageSize,
    }),
    prisma.tbPost.count({ where }),
  ])

  return { record, total, pageNum, pageSize }
}
```

### 插入操作

```typescript
/**
 * 创建用户
 */
export async function createUser(data: {
  username: string
  password: string
  nickname?: string
}) {
  const prisma = await getPrisma()

  // 检查用户名是否存在
  const existing = await prisma.tbUser.findUnique({
    where: { username: data.username },
  })

  if (existing) {
    throw new Error('用户名已存在')
  }

  return await prisma.tbUser.create({
    data: {
      username: data.username,
      password: data.password, // 已加密
      nickname: data.nickname || data.username,
      role: 'user',
    },
  })
}
```

### 更新操作

```typescript
/**
 * 软删除文章
 */
export async function deletePost(id: bigint) {
  const prisma = await getPrisma()

  return await prisma.tbPost.update({
    where: { id },
    data: {
      is_delete: 1,
      updated_at: new Date(),
    },
  })
}
```

### 事务操作

```typescript
/**
 * 创建文章并更新统计
 */
export async function createPostWithStats(data: {
  title: string
  content: string
  userId: bigint
}) {
  const prisma = await getPrisma()

  return await prisma.$transaction(async (tx) => {
    // 1. 创建文章
    const post = await tx.tbPost.create({
      data: {
        title: data.title,
        content: data.content,
        user_id: data.userId,
      },
    })

    // 2. 更新用户统计
    await tx.tbUser.update({
      where: { id: data.userId },
      data: {
        post_count: {
          increment: 1,
        },
      },
    })

    return post
  })
}
```

## 性能优化

### 索引策略
```sql
-- 常用索引建议
-- 主键索引：自动创建
-- 唯一索引：用户名、邮箱、手机号等
-- 普通索引：查询条件字段
-- 复合索引：多字段查询

-- 示例：文章表索引
ALTER TABLE tb_post
ADD INDEX idx_category_hide (category, hide),
ADD INDEX idx_date_hide (date, hide),
ADD INDEX idx_user (user_id);
```

### 避免全表扫描
```typescript
// ❌ 不好的做法 - 全表模糊查询
const posts = await prisma.tbPost.findMany({
  where: {
    OR: [
      { title: { contains: keyword } },
      { content: { contains: keyword } },
    ],
  },
})

// ✅ 好的做法 - 限制查询范围
const posts = await prisma.tbPost.findMany({
  where: {
    is_delete: 0,
    hide: '0',
    OR: [
      { title: { contains: keyword } },
      { content: { contains: keyword } },
    ],
  },
  take: 20, // 限制结果数量
  orderBy: { date: 'desc' },
})
```

### 批量操作优化
```typescript
// ❌ N+1 问题
for (const id of userIds) {
  await prisma.tbUser.findUnique({ where: { id } })
}

// ✅ 批量查询
await prisma.tbUser.findMany({
  where: { id: { in: userIds } }
})
```

## 安全规范

### 防止 SQL 注入
- ✅ 使用 Prisma（自动防护）
- ❌ 不要拼接 SQL 字符串

### 敏感字段保护
```typescript
// ✅ 不返回敏感字段
const user = await prisma.tbUser.findUnique({
  where: { id },
  select: {
    id: true,
    username: true,
    nickname: true,
    avatar: true,
    // 不返回：password, token 等
  },
})
```

## 常用命令

```bash
# 生成 Prisma Client
pnpm prisma generate

# 查看数据库（GUI）
pnpm prisma studio

# 数据库推送（开发环境，慎用）
pnpm prisma db push

# 从数据库同步 Schema
pnpm prisma db pull
```

## 工作流程

### 1. 新功能开发
```bash
# 1. 修改 Schema
vim prisma/schema.prisma

# 2. 生成 Client
pnpm prisma generate

# 3. 编写迁移 SQL
vim docs/migrations/20251218_001_feature.sql

# 4. 本地测试
mysql -u root -p dev_db < docs/migrations/20251218_001_feature.sql

# 5. 更新代码
vim src/services/xxx.ts
```

### 2. 生产部署
```bash
# 1. 备份数据库
mysqldump -u root -p prod_db > backup_prod.sql

# 2. 执行迁移
mysql -u root -p prod_db < docs/migrations/20251218_001_new.sql

# 3. 重启应用
pm2 restart ecosystem.config.cjs
```

## 核心原则

1. ✅ **手写 SQL 迁移脚本**，不使用 Prisma Migrate
2. ✅ **使用事务**保证数据一致性
3. ✅ **添加索引**优化查询性能
4. ✅ **软删除**保护数据安全
5. ✅ **记录迁移**便于追踪和回滚
6. ✅ **敏感字段**不返回给前端
