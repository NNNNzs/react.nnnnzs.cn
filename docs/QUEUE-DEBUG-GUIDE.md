# 队列监控问题排查指南

## 🔍 问题现象

点击"批量更新向量"后，队列监控页面看不到进行中的任务。

## 🛠️ 排查步骤

### 1. 检查控制台日志

查看开发服务器控制台，应该看到以下日志：

```
📦 批量添加 X 篇文章到向量化队列...
📊 找到 X 篇有效文章
✅ 已更新 X 篇文章状态为 pending
✅ 已将 X 个任务添加到队列
🚀 启动向量化队列
📊 配置: 并发=2, 最大重试=2
🔄 检查队列: 队列长度=X, 处理中=0, 并发限制=2
🎯 取出任务: 文章 X (标题)
```

**如果没有看到这些日志，说明队列没有被正确初始化。**

### 2. 检查浏览器 Network 面板

1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 点击"批量更新向量"按钮
4. 查看是否有以下请求：

**应该有的请求：**
- `POST /api/post/embed/batch` - 批量添加到队列
- `GET /api/post/embed/queue` - 查询队列状态

**检查响应：**
```json
// POST /api/post/embed/batch 响应
{
  "status": true,
  "data": {
    "total": 10,
    "queued": 10,
    "queueStatus": {
      "queueLength": 10,
      "processingCount": 0,
      "queueTasks": [...],
      "processingTasks": []
    }
  }
}
```

### 3. 检查队列状态 API

直接访问队列状态 API：
```bash
# 获取管理员 token 后
curl http://localhost:3000/api/post/embed/queue \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**预期响应：**
```json
{
  "status": true,
  "data": {
    "queueLength": 0,
    "processingCount": 0,
    "queueTasks": [],
    "processingTasks": [],
    "isRunning": true
  }
}
```

### 4. 手动测试单个文章

在文章列表页，点击某篇文章的"更新向量"按钮，观察：
1. 是否显示成功提示
2. 控制台是否有日志
3. 队列监控页面是否出现该任务

### 5. 检查队列初始化

在开发服务器启动时，应该看到：
```
🚀 初始化向量化队列...
```

**如果没有看到，说明 `embedding-init.ts` 没有被正确导入。**

## 🔧 常见问题

### 问题 1: 队列未启动

**症状**:
- 批量更新显示成功，但队列始终为空
- 控制台没有队列处理日志

**原因**:
- 队列实例在服务端和客户端不一致
- Next.js API 路由是独立的服务端实例

**解决方案**:
- 在 `add()` 方法中添加自动启动逻辑（已完成）
- 确保每次添加任务时队列都在运行

### 问题 2: 队列任务立即消失

**症状**:
- 任务被添加到队列
- 但立即就完成了（实际没有处理）

**原因**:
- 任务内容为空，被跳过
- 向量化失败但没有正确记录

**解决方案**:
- 检查文章 `content` 字段是否有内容
- 查看错误日志确认失败原因

### 问题 3: 队列状态不同步

**症状**:
- 前端显示有任务
- 但实际没有在处理

**原因**:
- 队列实例是单例，但 Next.js 每个请求可能创建新实例
- 内存队列在多实例环境下不一致

**临时解决方案**:
- 每次添加任务时自动启动队列
- 添加更多日志确认队列状态

**长期解决方案**:
- 使用 Redis 存储队列（持久化）
- 使用 Bull 或 Agenda 队列库

### 问题 4: 权限问题

**症状**:
- 返回 401 或 403 错误

**解决方案**:
- 确认已登录
- 确认用户角色是 `admin`
- 检查 token 是否有效

## 📊 调试日志说明

### 正常的处理流程日志

```
📦 批量添加 10 篇文章到向量化队列...
📊 找到 10 篇有效文章
✅ 已更新 10 篇文章状态为 pending
✅ 已将 10 个任务添加到队列
📥 文章 1 已添加到队列，当前队列长度: 1
📥 文章 2 已添加到队列，当前队列长度: 2
...
🔄 检查队列: 队列长度=10, 处理中=0, 并发限制=2
🎯 取出任务: 文章 1 (标题1)
🔄 开始处理文章 1 的向量化...
📝 开始对文章 1 进行语义切片...
✅ 文章 1 切片完成，共 5 个片段
🔢 开始生成文章 1 的向量嵌入...
✅ 文章 1 向量嵌入生成完成
🗑️ 删除文章 1 的旧向量数据...
💾 插入文章 1 的向量数据到 Qdrant...
✅ 文章 1 向量化完成：5 个向量已存储到 Qdrant
✅ 文章 1 向量化完成
✅ 文章 1 处理完成，剩余队列: 9
```

## 🧪 测试脚本

使用提供的测试脚本：
```bash
# 1. 修改脚本中的 TOKEN
# 2. 启动开发服务器
pnpm dev

# 3. 在另一个终端运行测试
node scripts/test-queue-api.mjs
```

## ✅ 验证清单

- [ ] 控制台有队列初始化日志
- [ ] 点击"批量更新"显示成功
- [ ] Network 面板看到 API 调用成功
- [ ] 队列监控页面显示队列长度 > 0
- [ ] 控制台有任务处理日志
- [ ] 队列监控页面显示"处理中"
- [ ] 任务完成后状态变为"已完成"

## 🆘 仍然无法解决？

1. **重启开发服务器**
   ```bash
   # 停止服务器 (Ctrl+C)
   pnpm dev
   ```

2. **清除浏览器缓存**
   - 硬刷新页面 (Ctrl+Shift+R)
   - 清除 LocalStorage

3. **检查环境变量**
   ```bash
   # 确认 Qdrant 配置正确
   cat .env | grep QDRANT
   ```

4. **查看完整错误日志**
   ```bash
   # 查看服务器日志
   pnpm dev 2>&1 | tee dev.log
   ```

5. **手动测试向量化**
   - 使用单个文章的"更新向量"按钮
   - 观察是否成功

---

**创建时间**: 2026-01-17
**版本**: 1.0.0
