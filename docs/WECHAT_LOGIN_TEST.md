# 微信扫码登录功能测试清单

## 测试前准备

### 1. 环境配置检查

- [ ] `.env` 文件中已配置 `WX_APP_ID` 和 `WX_APP_SECRET`
- [ ] Redis 服务正常运行
- [ ] 数据库已执行 `prisma db push` 或迁移
- [ ] 项目已安装所有依赖 (`pnpm install`)
- [ ] 已执行 `pnpm prisma generate`

### 2. 启动服务

```bash
# 开发环境
pnpm dev

# 访问地址
http://localhost:3000
```

## 功能测试

### 测试一：扫码登录（新用户自动注册）

#### 步骤：
1. [ ] 访问登录页面：`http://localhost:3000/login`
2. [ ] 点击「微信登录」标签页
3. [ ] 确认显示二维码图片
4. [ ] 使用微信扫描二维码
5. [ ] 在小程序中查看授权页面
6. [ ] 点击「允许」授权
7. [ ] 观察网页端状态变化

#### 预期结果：
- [ ] 二维码正常显示
- [ ] 扫码后提示「扫码成功，请在手机上确认」
- [ ] 授权后提示「确认成功，即将跳转登录」
- [ ] 显示用户昵称和头像
- [ ] 自动跳转到后台管理页面 `/c`
- [ ] 数据库中创建了新用户记录，包含 `wx_open_id`

#### 验证数据库：
```sql
-- 查看新创建的用户
SELECT id, account, nickname, wx_open_id, registered_time 
FROM tb_user 
ORDER BY id DESC 
LIMIT 1;
```

### 测试二：扫码登录（已注册用户）

#### 步骤：
1. [ ] 退出登录
2. [ ] 再次访问登录页面
3. [ ] 点击「微信登录」标签页
4. [ ] 使用同一个微信扫描二维码
5. [ ] 在小程序中确认授权

#### 预期结果：
- [ ] 直接登录成功，不创建新用户
- [ ] 登录的是之前创建的账号
- [ ] 跳转到后台管理页面

### 测试三：绑定微信（已登录用户）

#### 步骤：
1. [ ] 使用账号密码登录一个普通账号
2. [ ] 访问个人中心：`http://localhost:3000/c/user/info`
3. [ ] 找到「微信绑定」卡片
4. [ ] 确认显示「未绑定」状态
5. [ ] 点击「绑定微信」按钮
6. [ ] 弹出绑定弹窗，显示二维码
7. [ ] 使用微信扫描二维码
8. [ ] 在小程序中确认授权

#### 预期结果：
- [ ] 弹窗正常显示二维码
- [ ] 扫码授权后提示「绑定成功」
- [ ] 弹窗自动关闭
- [ ] 「微信绑定」卡片状态变为「已绑定」
- [ ] 数据库中该用户的 `wx_open_id` 字段已更新

#### 验证数据库：
```sql
-- 查看用户的微信绑定状态
SELECT id, account, nickname, wx_open_id 
FROM tb_user 
WHERE account = '你的账号';
```

### 测试四：解绑微信

#### 步骤：
1. [ ] 在个人中心页面
2. [ ] 确认「微信绑定」卡片显示「已绑定」状态
3. [ ] 点击「解绑微信」按钮
4. [ ] 在确认弹窗中点击「确认」

#### 预期结果：
- [ ] 显示确认弹窗
- [ ] 解绑成功后提示「解绑成功」
- [ ] 「微信绑定」卡片状态变为「未绑定」
- [ ] 数据库中该用户的 `wx_open_id` 字段为 NULL

### 测试五：重复绑定检测

#### 步骤：
1. [ ] 用户 A 绑定微信 openid_123
2. [ ] 用户 B 尝试绑定同一个微信 openid_123

#### 预期结果：
- [ ] 用户 B 绑定时提示「该微信已被其他账号绑定」
- [ ] 绑定失败

### 测试六：二维码刷新

#### 步骤：
1. [ ] 在登录页面的微信登录标签页
2. [ ] 等待一段时间（不扫码）
3. [ ] 点击「刷新二维码」按钮

#### 预期结果：
- [ ] 显示加载状态
- [ ] 生成新的二维码
- [ ] 旧的 token 失效

### 测试七：二维码过期

#### 步骤：
1. [ ] 获取一个二维码
2. [ ] 等待 1 小时（或手动删除 Redis 中的 key）
3. [ ] 尝试扫描该二维码

#### 预期结果：
- [ ] 提示「二维码已过期」
- [ ] 无法完成登录

### 测试八：状态轮询

#### 步骤：
1. [ ] 打开浏览器开发者工具 Network 标签页
2. [ ] 访问微信登录页面
3. [ ] 观察网络请求

#### 预期结果：
- [ ] 每 2 秒发送一次 `/api/wechat/status` 请求
- [ ] 扫码后状态从 -1 变为 0
- [ ] 授权后状态从 0 变为 1
- [ ] 登录成功后停止轮询

## API 接口测试

### 1. 获取 Token

```bash
curl http://localhost:3000/api/wechat/getToken
```

预期响应：
```json
{
  "status": true,
  "data": "32位TOKEN字符串"
}
```

### 2. 获取小程序码

```bash
curl "http://localhost:3000/api/wechat/getImg?token=你的TOKEN&env=trial" -o qrcode.png
```

预期结果：生成 `qrcode.png` 图片文件

### 3. 获取状态

```bash
curl "http://localhost:3000/api/wechat/status?token=你的TOKEN"
```

预期响应：
```json
{
  "status": true,
  "data": -1  // -1, 0, 或 1
}
```

### 4. code2Session（小程序端调用）

```bash
curl "http://localhost:3000/api/wechat/code2Session?code=微信登录凭证"
```

预期响应：
```json
{
  "status": true,
  "data": {
    "openid": "微信openid",
    "session_key": "会话密钥"
  }
}
```

## 常见问题排查

### 问题 1：无法生成二维码

**检查项：**
- [ ] 查看浏览器控制台是否有错误
- [ ] 查看服务器日志
- [ ] 确认环境变量配置正确
- [ ] 测试微信 API 连接性

**解决方法：**
```bash
# 测试获取 access_token
curl "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=你的APPID&secret=你的SECRET"
```

### 问题 2：扫码无响应

**检查项：**
- [ ] Redis 是否正常运行
- [ ] 浏览器控制台是否有网络错误
- [ ] 服务器日志是否有错误
- [ ] 小程序是否正确调用了接口

**调试命令：**
```bash
# 检查 Redis 连接
redis-cli ping

# 查看 Redis 中的 key
redis-cli keys "wechat_screen_key/*"

# 查看某个 key 的值
redis-cli get "wechat_screen_key/你的TOKEN"
```

### 问题 3：绑定失败

**检查项：**
- [ ] 用户是否已登录
- [ ] 该 openid 是否已被绑定
- [ ] 查看服务器日志获取详细错误

**调试 SQL：**
```sql
-- 查看所有已绑定微信的用户
SELECT id, account, nickname, wx_open_id 
FROM tb_user 
WHERE wx_open_id IS NOT NULL;

-- 查找特定 openid 的绑定情况
SELECT * FROM tb_user WHERE wx_open_id = '特定的openid';
```

## 性能测试

### 并发测试

测试多个用户同时扫码登录：

```bash
# 使用 Apache Bench 测试
ab -n 100 -c 10 http://localhost:3000/api/wechat/getToken
```

### 压力测试

观察以下指标：
- [ ] Redis 连接数
- [ ] 数据库连接数
- [ ] 内存使用率
- [ ] CPU 使用率
- [ ] 响应时间

## 测试完成标准

- [ ] 所有功能测试通过
- [ ] 所有 API 接口正常
- [ ] 无错误日志
- [ ] 性能符合预期
- [ ] 数据库记录正确

## 测试报告模板

```markdown
# 微信扫码登录功能测试报告

测试日期：____年__月__日
测试人员：________
测试环境：开发环境 / 测试环境 / 生产环境

## 测试结果汇总

| 功能 | 通过 | 失败 | 备注 |
|------|------|------|------|
| 扫码登录（新用户） | ✓ / ✗ | - | |
| 扫码登录（老用户） | ✓ / ✗ | - | |
| 绑定微信 | ✓ / ✗ | - | |
| 解绑微信 | ✓ / ✗ | - | |
| 重复绑定检测 | ✓ / ✗ | - | |
| 二维码刷新 | ✓ / ✗ | - | |
| 二维码过期 | ✓ / ✗ | - | |
| 状态轮询 | ✓ / ✗ | - | |

## 发现的问题

1. 
2. 
3. 

## 建议和改进

1. 
2. 
3. 

## 总结

测试通过率：___%
主要问题：
建议上线：是 / 否
```
